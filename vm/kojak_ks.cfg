#version=DEVEL
# System authorization information
auth --enableshadow --passalgo=sha512
# Use CDROM installation media
cdrom
# Run the Setup Agent on first boot
firstboot --enable
ignoredisk --only-use=vda
# Keyboard layouts
keyboard --vckeymap=us --xlayouts='us'
# System language
lang en_US.UTF-8
# Network information
network --hostname=kojak.localdomain
# Root password
rootpw --iscrypted $6$FEn6UMGPZvkAS0Tc$z7g4Bgkm7gNeMRkZlL3.eR0695b5k8FQuraC8nDIwYY7sricsRw7u9aGiJUKjb8n6RGgf0ghkLqfmBUPaOFHE1
# System timezone
timezone America/New_York --isUtc
# X Window System configuration information
xconfig --startxonboot
# System bootloader configuration
bootloader --location=mbr --boot-drive=vda
autopart --type=lvm
# Partition clearing information
clearpart --none --initlabel --drives=vda

# Reboot once done
reboot

%packages
@base-x
@core
@firefox
@fonts
@gnome-desktop
@hardware-support
@input-methods
@standard

%end

%post --log=/root/kojak_ks_post.log
echo "################################"
echo "#  Running Kojok Post Install  #"
echo "################################"


echo "# Install koji packages"
cd /tmp
wget http://download.devel.redhat.com/rel-eng/brew/fedora/18/brew.repo
cp brew.repo /etc/yum.repos.d
yum -y install httpd mod_ssl postgresql-server mod_wsgi mock rpm-build createrepo koji koji-builder koji-hub koji-hub-plugins koji-utils koji-vm koji-web

echo "# Creating Koji user"
useradd koji
echo koji | passwd koji --stdin
mkdir -p /home/koji/.koji/config
chown koji:apache /home/koji/.koji/config

echo "# Create koji build directories"
mkdir /mnt/koji
cd /mnt/koji
mkdir {packages,repos,work,scratch}
chown apache.apache *
cd -

cat > /etc/rc.d/init.d/kojak << EOF
#!/bin/bash
#
# Kojak: Run once configuration
#
# chkconfig: 345 00 99
# description: Kojak configuration script.

echo "# Initialise the database"
postgresql-setup initdb

echo "# Bring the datatbase up"
service postgresql start
chkconfig postgresql on

echo "# Create the db table spaces"

su -l postgres -c "createuser koji"
su -l postgres -c "createdb -O koji koji"

echo "# Create the db tables"
su -l koji -c "psql koji koji < /usr/share/doc/koji*/docs/schema.sql"
su -l koji -c "psql koji koji insert into users (name, status, usertype) values ('kojiadmin', 0, 0);"
su -l koji -c "psql koji koji insert into user_perms (user_id, perm_id, creator_id) values (1, 1, 1);"
su -l koji -c "psql koji koji insert into users (name, status, usertype) values ('koji', 0, 0);"
su -l koji -c "psql koji koji insert into user_perms (user_id, perm_id, creator_id) values (2, 1, 1);"

echo "# Disable firewall"
systemctl disable firewalld.service
systemctl stop firewalld.service
systemctl disable iptables.service
systemctl stop iptables.service
systemctl disable ip6tables.service
systemctl stop ip6tables.service

echo "# Remove Kojak config script"
chkconfig --del kojak
rm /etc/rc.d/init.d/kojak
reboot

EOF

echo "# Initialise Kojak"
chmod +x /etc/rc.d/init.d/kojak
systemctl enable kojak.service

%end
